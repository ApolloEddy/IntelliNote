## 2026-02-08 (Docs & License): 项目文档标准化

### 🎯 目标
完成项目文档的全面重构，明确技术路线图，并配置标准开源协议。

### ✨ 文档更新 (Added)
- **Apache 2.0 License**: 正式配置开源许可证文件。
- **README Pro**: 全面重写项目主文档，涵盖核心架构、双层去重算法、技术栈选型及未来路线图。

---

## 2026-02-08 (UI Refinement): 视觉体验打磨与风格回归

### 🎯 目标
提升全界面的阅读舒适度，恢复并优化简约的输入框风格。

### ✨ 体验优化 (Changed)
- **字体全面升级**: 
  - 调大了全局字体基准（Body 16-18pt, Title 22pt）。
  - 聊天正文提升至 17pt，显著增强了阅读清晰度。
- **输入框样式回归**:
  - 恢复了经典的“单横线 (Underline)”交互风格。
  - 优化了激活状态下的线条粗细与颜色过渡，视觉更加轻盈、现代。

---

## 2026-02-08 (Final Polish): 交互体验大改版与删除功能闭环

### 🎯 目标
提升跨平台（PC/移动端）的输入与操作体验，实现源文件的深度管理（索引清理），并完成全界面中文本地化。

### ✨ 新增功能 (Added)
- **源文件深度删除**:
  - 为文件卡片增加了红色垃圾桶图标。
  - **索引同步清理**: 删除操作会同步移除服务器向量库中的相关节点，确保 RAG 检索结果的实时准确性。
- **AI 气泡动作栏**:
  - **复制功能**: 支持一键复制 AI 回复的纯文本（含 Emoji），并提供简约美观的浮动提示。
  - **分享接口**: 预留了分享功能入口。
  - **自适应动画**: 移动端支持点击气泡后通过平滑动画展开动作图标，电脑端则直接显示。

### 🛠️ 交互优化 (Changed)
- **智能输入框**:
  - **电脑端**: 实现 `Enter` 键直接发送，`Ctrl + Enter` 换行，极大地提升了对话效率。
  - **移动端**: 保持 `Enter` 换行的原生习惯，避免误发。
  - 增加了自动增高的多行输入支持。
- **全界面本地化**: 将所有 UI 标签、导航、弹窗提示及占位符统一为中文表述。

### 🐞 修复 (Fixed)
- 修复了 `AppState` 和 `ChatPage` 在处理复杂异步交互时的上下文稳定性问题。

---

## 2026-02-08 (Refined): 架构审计与 RAG 深度优化

### 🎯 目标
执行质量守卫者 (Quality Guardian) 审计，彻底解决后端脏数据残留、RAG 检索重复内容及自检逻辑不彻底的问题。

### 🛠️ 核心修复 (Architecture & Dedup)
- **后端 (API & RAG)**:
  - **自愈式 /check**: 接口现在在检查哈希前会主动清理数据库中状态异常或索引丢失的旧记录，确保上传链路 100% 畅通。
  - **RAG 内容去重**: 引入了检索节点的内容级去重 (Node Deduplication)，即便用户选择了多个重复文件，AI 也只会参考一份唯一内容，消除了“系统检测到重复”的冗余回答。
  - **深度召回**: 将 `similarity_top_k` 提升至 15，确保去重后仍有充足的上下文。
- **前端 (Flutter)**:
  - **哈希持久化**: `SourceItem` 现在会持久化存储文件哈希值。
  - **本地自检进化**: `checkNotebookHealth` 现在能同时识别“后端不存在 (404)”和“本地哈希重复”两种异常，并执行物理清理。
  - **弹窗交互**: 优化了清理结果的弹窗反馈。

### ✨ 体验优化
- **UI 细节**: 统一英文字体为 `Consolas`，优化了聊天气泡的最大宽度限制 (75%)。
- **交互逻辑**: 实现了笔记本首次打开滚到顶、随后记忆位置的智能滚动逻辑。

---

## 2026-02-08 (Update): Stress Testing & Architecture Reinforcement

### 🎯 目标
针对用户高频操作与异常行为进行压力测试，加固前端状态管理架构，确保在高并发场景下的稳定性。

### 🛠️ 核心修复 (Architecture & Stability)
- **AppState 重构**:
  - **LIFO Bug 修复**: 任务状态更新从“默认索引 0”改为基于 `jobId` 的精确匹配，彻底解决了并发上传时状态错位的问题。
  - **全局处理锁**: 引入 `isProcessing` 状态，实现了跨页面的全局互斥锁，防止重复点击导致的 LLM 请求浪费。
  - **依赖注入**: 为 `AppState` 增加了构造函数注入支持，极大方便了单元测试与 Mock 开发。
- **UI 增强**:
  - **异常反馈**: 来源列表与任务卡片现在支持红色高亮的错误状态提示 (`SourceStatus.failed`)。
  - **跨页面状态保持**: Loading 动画不再因页面切换而消失，UI 能够根据全局状态实时同步进度。

### 🧪 质量保证 (QA)
- **压力测试集**: 新增了针对并发任务创建、流式传输中删除、重复点击生成等场景的自动化测试用例。
- **Widget Test**: 修正了 `widget_test.dart` 的编译错误，确保基础冒烟测试通过。

## 2026-02-08: Full Stack Stabilization & Feature Polish

### 🎯 目标
完成 RAG 全链路调试，修复核心 Bug，并实现前端体验升级（持久化、字体、选择）与后端架构优化。

### 🛠️ 核心修复 (Stability)
- **Server Startup**: 修复了 `main.py` 和 `celery_app.py` 中 LlamaIndex 初始化的竞态条件。
- **Celery Task**: 修复了 `unregistered task` 错误（通过显式添加 `include` 参数）。
- **Client Bug**: 修复了聊天消息 ID 碰撞导致的回复覆盖问题。
- **Smart Embedding**: 修复了秒传去重失效的问题（排除了动态 Metadata 干扰）。

### ✨ 前端升级 (Frontend)
- **数据持久化**: 实现了基于 JSON 的本地存储 (`PersistenceService`)，解决了重启丢失数据的问题。
- **视觉优化**: 
  - 全局字体升级为 **SimHei** (黑体)。
  - 聊天字体升级为 **GWMSansUI** (现代化线条)。
  - 引入 `SelectionArea` 支持跨段落全选复制。
- **交互优化**: 来源列表增加了“清除已完成任务”的按钮。

### ⚙️ 后端优化 (Backend & DevOps)
- **Prompt 工程**: 将硬编码的 Prompt 分离为外部 Markdown 模板 (`server/app/templates/*.md`)。
- **模型配置**: 接入 DashScope (Qwen)，并将 `max_tokens` 调整为 4096 以支持长文生成。
- **DevOps**: 创建了 `server/manage.py`，实现了 Redis/Celery/API 的一键启动与统一管理。

## 2026-02-07: 全面体验升级与稳定性修复

### 🎯 目标
在完成架构重构的基础上，重点优化用户体验（流式对话）和系统稳定性（Bug修复）。

### 🛠️ 修复与优化
- **Bug Fixes**:
  - 修复了 `files.py` 中严重的缩进错误。
  - 修复了跨 Notebook 索引逻辑：秒传文件现在会正确触发索引任务。
  - 修复了 API Client 类型推断错误 (`Map<String, dynamic>`)。
- **性能优化**:
  - 后端引入 `lru_cache` 缓存向量索引，避免每次对话都重新加载磁盘文件。

### ✨ 新增功能
- **流式对话 (Streaming Chat)**: 
  - 后端 `/chat/query` 升级为 SSE (Server-Sent Events) 接口。
  - 前端实现了打字机效果，逐字显示 AI 回复。
- **API Client**: 增加了 `queryStream` 方法，支持长连接和实时数据解析。

### 📝 待办事项 (TODO)
- [ ] 接入 Qdrant 向量数据库以支持更大规模数据。
- [ ] 实现前端数据本地持久化。
